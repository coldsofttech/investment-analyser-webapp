<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Investment Analyser - Stocks</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" 
              integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/2.3.1/css/dataTables.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.min.css">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.0/themes/smoothness/jquery-ui.css">
        <link href="../../static/css/styles.css" rel="stylesheet">
        <style>
            .w-next-responsive {
                width: 100px;
            }

            .w-submit-responsive {
                width: 120px;
            }

            #inputTableMobileView {
                display: none;
            }

            .ui-dialog, .ui-widget {
                font-family: inherit !important;
                font-size: inherit !important;
            }

            .ui-dialog-titlebar-close {
                display: block !important;
                visibility: visible !important;
            }

            .ui-widget-header {
                background: none;
                background-color: #3498db !important;
                color: white !important;
            }

            .ui-dialog-buttonpane button {
                border: none !important;
                background-color: #3498db !important;
                color: white !important;
            }

            @media (min-width: 769px) {
                .ui-dialog {
                    max-width: 800px !important;
                }
            }

            @media (max-width: 768px) {
                .w-next-responsive,
                .w-submit-responsive {
                    width: 50px !important;
                    padding-left: 0.5rem;
                    padding-right: 0.5rem;
                }

                #inputTableDesktopView {
                    display: none;
                }

                #inputTableMobileView {
                    display: block;
                }

                .ui-dialog {
                    width: 95% !important;
                    left: 2.5% !important;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="freeze-pane">
                <div id="userbar-placeholder"></div>
                <div id="header-placeholder"></div>
            </div>
            <div id="error-placeholder"></div>
            <div id="menu-placeholder"></div>
            
            <div class="form">
                <div class="row padding">
                    <div class="col-md-12">
                        <strong>Enter Pie details to analyse:</strong>
                    </div>
                </div>

                <div class="row padding">
                    <div class="col-md-4">
                        <label for="name">Pie name</label>
                        <i class="optional-text">(Name of the Pie, like TechTrickle, MachIncome, etc.)</i>
                    </div>
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" name="name" id="name" placeholder="Name"
                                   required>
                            <l class="input-group-text bi bi-alphabet-uppercase"></i>
                        </div>
                    </div>
                </div>

                <div class="row padding">
                    <div class="col-md-4">
                        <label for="noOfStocks">No. of Stocks</label>
                        <i class="optional-text">(Range accepted between 1 and 50)</i>
                    </div>
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="number" class="form-control" name="noOfStocks" id="noOfStocks" 
                                   placeholder="0" min="1" max="50" required> 
                            <i class="input-group-text bi bi-123"></i>
                        </div>
                    </div>
                </div>

                <div class="row padding">
                    <div class="col-md-12 text-right">
                        <button type="button" id="next" class="btn btn-custom-blue w-next-responsive" title="Next">
                            <i class="bi bi-arrow-right-circle"></i>
                            <span class="d-none d-md-inline">Next</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="input-container" class="d-none">
                <div class="row padding">
                    <div class="col-md-12">
                        <div id="inputTableDesktopView">
                            <table id="inputTable" class="display dataTable">
                                <thead>
                                    <tr>
                                        <th class="text-right">#</th>
                                        <th>Ticker</th>
                                        <th class="text-right">Stocks Owned</th>
                                        <th class="text-right">Avg. Price</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="inputTableMobileView" class="accordion"></div>
                    </div>
                </div>
                <div class="row padding">
                    <div class="col-md-12 text-right">
                        <button type="submit" id="submit" class="btn btn-custom-blue w-submit-responsive" title="Analyse">
                            <i class="bi bi-clipboard2-data me-md-0 me-0"></i>
                            <span class="d-none d-md-inline">Analyse</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="input-dialog" title="Enter Stock details" style="display: none;">
                <div class="container">
                    <div id="tickerinputform-placeholder"></div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
                integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
                crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" 
                integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" 
                crossorigin="anonymous"></script>
        <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
        <script src="https://cdn.datatables.net/2.3.1/js/dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.min.js"></script>
        <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.min.js" 
                integrity="sha256-Fb0zP4jE3JHqu+IBB9YktLcSjI1Zc6J2b6gTjB0LpoM=" 
                crossorigin="anonymous"></script>
        <script src="../../static/js/utils.js"></script>
        <script src="../../static/js/auth0.js"></script>
        <script src="../../static/js/currency.js"></script>
        <script src="../../static/js/validations.js"></script>

        <script>
            let name = null;
            let noOfStocks = null;
            let tableExists = null;
            let inputTable = null;

            $(async function() {
                const htmlFragments = [
                    {
                        selector: '#error-placeholder',
                        url: '../../public/error.html',
                        eventName: 'errorReady'
                    },
                    {
                        selector: '#userbar-placeholder',
                        url: '../../public/user-bar.html',
                        eventName: 'userBarReady'
                    },
                    {
                        selector: '#header-placeholder',
                        url: '../../public/header.html',
                        eventType: 'CustomEvent',
                        eventName: 'headerReady',
                        detail: {
                            title: 'Pie Analyser',
                            logo: ''
                        }
                    },
                    {
                        selector: '#menu-placeholder',
                        url: '../../public/menu.html',
                        eventName: 'menuReady'
                    },
                    {
                        selector: '#tickerinputform-placeholder',
                        url: '../../public/stocks/ticker-input-form.html',
                        eventName: 'tickerInputFormReady',
                    }
                ];

                await loadAllFragments(htmlFragments);
                await initNext();
            });

            async function initNext() {
                $('#next').click(async function() {
                    name = $('#name').val();
                    noOfStocks = parseInt($('#noOfStocks').val());

                    if (!name) {
                        return displayError('Please enter a name for the Pie.');
                    }

                    if (isNaN(noOfStocks) || noOfStocks < 1 || noOfStocks > 50) {
                        return displayError('Please enter a valid number of stocks (1 to 50).')
                    }

                    removeError();

                    tableExists = $.fn.DataTable.isDataTable('#inputTable');
                    const hasData = tableExists && $('#inputTable').DataTable().data().count() > 0;

                    if (hasData) {
                        $(`
                            <div title="Confirm Overwrite">
                                Proceeding will clear existing data. Do you want to continue?
                            </div>
                        `).dialog({
                            modal: true,
                            width: 'auto',
                            maxWidth: 800,
                            height: 'auto',
                            resizable: false,
                            closeText: 'X',
                            show: true,
                            buttons: [
                                {
                                    html: '<span>Yes</span>',
                                    class: 'btn btn-sm btn-custom-blue',
                                    click: async function() {
                                        $(this).dialog('close');
                                        await initInputTable();
                                    }
                                },
                                {
                                    html: '<span>No</span>',
                                    class: 'btn btn-sm btn-custom-blue',
                                    click: function() {
                                        $(this).dialog('close');
                                    }
                                }
                            ],
                            create: function() {
                                $(this).closest('.ui-dialog')
                                       .find('.ui-dialog-titlebar-close')
                                       .show();
                            },
                            open: function() {
                                $(this).dialog('option', 'position', {
                                    my: 'center',
                                    at: 'center',
                                    of: window
                                });

                                const closeBtn = $(this).parent().find('.ui-dialog-titlebar-close');
                                if (closeBtn.length && closeBtn.html().trim() === '') {
                                    closeBtn.html(`
                                        <span class="ui-button-icon ui-icon ui-icon-closethick"></span>
                                        <span class="ui-button-icon-space"> </span>
                                    `);
                                }
                            }
                        });
                    } else {
                        await initInputTable();
                    }

                    await initDialog();
                });
            }

            async function initDialog() {
                $('#inputTable tbody').on('click', '.fill-btn', function() {
                    const rowIdx = $(this).data('row');
                    const rowData = inputTable.row(rowIdx).data();

                    $('#rowIndex').val(rowIdx);
                    $('#ticker').val(rowData[1] || '');
                    $('#stocksOwned').val(rowData[2] || '');
                    $('#avgPrice').val(rowData[3] || '');
                    $('#input-dialog').dialog({
                        modal: true,
                        width: 'auto',
                        maxWidth: 800,
                        height: 'auto',
                        resizable: false,
                        closeText: 'X',
                        show: true,
                        buttons: [
                            {
                                html: '<i class="bi bi-floppy"></i>',
                                class: 'btn btn-sm btn-custom-blue',
                                click: function() {
                                    const idx = $('#rowIndex').val();
                                    const ticker = $('#ticker').val();
                                    const stocksOwned = $('#stocksOwned').val();
                                    const avgPrice = $('#avgPrice').val();

                                    if (!ticker) {
                                        return alert('Ticker is required!');
                                    }

                                    if (!stocksOwned) {
                                        return alert('Stocks Owned is required!');
                                    }

                                    if (!avgPrice) {
                                        return alert('Avg. Price is required!');
                                    }

                                    inputTable.row(idx).data([
                                        parseInt(idx) + 1, 
                                        ticker,
                                        stocksOwned,
                                        avgPrice,
                                        `<button class='btn btn-sm btn-custom-blue fill-btn' data-row='${idx}'><i class='bi bi-pencil'></i></button>`
                                    ]).draw(false);
                                    inputTable[idx] = { ticker, stocksOwned, avgPrice };
                                    $(this).dialog('close');
                                }
                            }
                        ],
                        create: function() {
                            $(this).closest('.ui-dialog')
                                   .find('.ui-dialog-titlebar-close')
                                   .show();
                        },
                        open: function() {
                            $(this).dialog('option', 'position', {
                                my: 'center',
                                at: 'center',
                                of: window
                            });

                            const closeBtn = $(this).parent().find('.ui-dialog-titlebar-close');
                            if (closeBtn.length && closeBtn.html().trim() === '') {
                                closeBtn.html(`
                                    <span class="ui-button-icon ui-icon ui-icon-closethick"></span>
                                    <span class="ui-button-icon-space"> </span>
                                `);
                            }
                        }
                    });
                });
            }

            async function initInputTable() {
                $('#input-container').removeClass('d-none');

                if (tableExists) {
                    $('#inputTable').DataTable().clear().destroy();
                }

                inputTable = $('#inputTable').DataTable({
                    columnDefs: [{
                        targets: [0, 2, 3, 4],
                        createdCell: function(td, cellData, rowData, row, col) {
                            $(td).css('text-align', 'right');
                        }
                    }]
                });

                const inputCount = noOfStocks;
                for (let i = 0; i < inputCount; i++) {
                    inputTable.row.add([
                        i + 1, '', '', '',
                        `<button class='btn btn-sm btn-custom-blue fill-btn' data-row='${i}'><i class='bi bi-pencil'></i></button>`
                    ]).draw(false);
                }
            }
        </script>
    </body>
</html>